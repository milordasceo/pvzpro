<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>pvzqr.ru — QR для ПВЗ</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; background:#0b0b0d; color:#fff; display:flex; flex-direction:column; min-height:100vh; }
    header { padding:16px; text-align:center; font-weight:600; }
    main { flex:1; display:flex; align-items:center; justify-content:center; padding:16px; }
    #card { background:#111215; border-radius:12px; padding:24px; width:min(92vw,520px); box-shadow:0 10px 30px rgba(0,0,0,.35); }
    #pvz { opacity:.85; font-size:14px; margin:0 0 8px; }
    #timer { opacity:.8; font-size:13px; margin-top:8px; }
    #qr { display:flex; align-items:center; justify-content:center; aspect-ratio:1/1; background:#fff; border-radius:8px; padding:12px; }
    footer { padding:12px; text-align:center; opacity:.5; font-size:12px; }
    .row { display:flex; gap:8px; }
    .field { display:flex; flex-direction:column; gap:6px; margin:8px 0; }
    .input { background:#0f1013; color:#fff; border:1px solid #272a31; border-radius:8px; padding:10px 12px; outline:none; }
    .btn { background:#2563eb; color:#fff; border:none; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .btn.ghost { background:#1f2937; }
    .hint { font-size:12px; opacity:.7; }
    #pairImg { display:block; width:320px; height:320px; background:#fff; border-radius:8px; object-fit:contain; margin:8px auto; }
    #pairActions { display:flex; gap:8px; justify-content:center; margin-top:8px; }
  </style>
  <script></script>
</head>
<body>
  <header>QR для входа в смену</header>
  <main>
    <div id="card">
      <div id="setup" style="display:none">
        <div class="field">
          <label>Ноутбук не привязан</label>
          <div id="pairInfo" class="hint">Нажмите «Привязать ноутбук», затем в приложении владельца сканируйте QR, который появится ниже.</div>
        </div>
        <img id="pairImg" alt="QR привязки" style="display:none" />
        <div id="pairTimer" class="hint" style="text-align:center"></div>
        <div id="pairActions" class="row">
          <button id="pairStart" class="btn">Привязать ноутбук</button>
          <button id="regen" class="btn ghost" style="display:none">Сгенерировать заново</button>
        </div>
      </div>

      <div id="viewer" style="display:none">
        <div id="pvz"></div>
        <div id="qr"><img id="qrImg" alt="QR" style="display:block;width:512px;height:512px;background:#fff;border-radius:8px;object-fit:contain"/></div>
        <div id="timer"></div>
        <div class="row" style="margin-top:10px; justify-content:space-between">
          <button id="refresh" class="btn ghost">Обновить</button>
          <button id="openSetup" class="btn ghost">Настроить</button>
        </div>
      </div>
    </div>
  </main>
  <footer>pvzqr.ru</footer>

  <script>
    const qs = new URLSearchParams(location.search);
    const qrImg = document.getElementById('qrImg');
    const timerEl = document.getElementById('timer');
    const pvzEl = document.getElementById('pvz');
    const setupBox = document.getElementById('setup');
    const viewerBox = document.getElementById('viewer');
    const pairImg = document.getElementById('pairImg');
    const pairTimer = document.getElementById('pairTimer');
    const regenBtn = document.getElementById('regen');
    const pairStartBtn = document.getElementById('pairStart');
    const refreshBtn = document.getElementById('refresh');
    const openSetup = document.getElementById('openSetup');

    const LS = {
      get pvzId(){ return localStorage.getItem('pvzId') || ''; },
      set pvzId(v){ localStorage.setItem('pvzId', v); },
      get ttl(){ return parseInt(localStorage.getItem('ttl')||'120',10); },
      set ttl(v){ localStorage.setItem('ttl', String(v)); },
    };

    let exp = 0;
    let tickTimer = null;
    let pairing = false;
    let pairExp = 0;
    let pairTick = null;
    let pollId = null;

    async function refreshQr(){
      
      // pvzId берём не из URL — он определяется сервером по привязке устройства
      const pvzId = '(привязано)';
      const ttlSec = Math.max(30, Math.min(parseInt(qs.get('ttlSec')||LS.ttl||120,10), 3600));
      if(!pvzId){ return; }
      try{
        const url = `/api/sign.php?ttlSec=${ttlSec}`;
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok){
          if(res.status === 403){
            // Нет привязки — показываем сообщение и кнопку для старта привязки
            setupBox.style.display='block';
            viewerBox.style.display='none';
            pairImg.style.display='none';
            pairTimer.textContent='';
            regenBtn.style.display='none';
            return;
          }
          timerEl.textContent = `Ошибка: HTTP ${res.status}`;
          return;
        }
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch(e) {
          console.error('Bad JSON from', url, text);
          timerEl.textContent = 'Ошибка JSON ответа';
          return;
        }
        if(!data || !data.payload){ throw new Error('bad-response'); }
        // Рисуем QR через внешний генератор изображения (без JS-библиотек)
        const imgUrl = `https://api.qrserver.com/v1/create-qr-code/?size=512x512&data=${encodeURIComponent(data.payload)}`;
        qrImg.src = imgUrl;
        exp = Number(data.exp)||0;
        pvzEl.textContent = `ПВЗ: ${data.pvzId || '—'}`;
      }catch(e){
        console.error('QR refresh error', e);
        timerEl.textContent = 'Ошибка загрузки QR';
      }
    }

    function startTicker(){
      if(tickTimer) clearInterval(tickTimer);
      tickTimer = setInterval(()=>{
        const now = Math.floor(Date.now()/1000);
        const left = Math.max(0, exp-now);
        timerEl.textContent = left>0 ? `Обновление через ${left}с` : 'Обновление...';
        if(left<=0){ refreshQr(); }
      }, 1000);
    }

    async function startPairing(){
      try{
        pairing = true;
        setupBox.style.display='block'; viewerBox.style.display='none';
        const res = await fetch('/api/pair-start.php', { cache:'no-store' });
        const data = await res.json();
        const { nonce, exp } = data;
        if(!nonce||!exp){ pairTimer.textContent='Ошибка генерации'; return; }
        pairImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=${encodeURIComponent('bind:'+nonce)}`;
        pairImg.style.display='block';
        regenBtn.style.display='inline-block';
        pairExp = exp;
        if(pairTick) clearInterval(pairTick);
        pairTick = setInterval(()=>{
          const now = Math.floor(Date.now()/1000);
          const left = Math.max(0, pairExp-now);
          pairTimer.textContent = left>0 ? `QR привязки истечёт через ${left}с` : 'QR истёк';
          if(left<=0){ clearInterval(pairTick); }
        },1000);
        // Параллельно опрашиваем sign.php — после привязки начнёт отвечать 200
        if(pollId) clearInterval(pollId);
        pollId = setInterval(async ()=>{
          const r = await fetch('/api/sign.php');
          if(r.ok){ clearInterval(pollId); pairing=false; showViewer(); refreshQr(); startTicker(); }
        }, 3000);
      }catch{
        pairTimer.textContent = 'Ошибка привязки';
      }
    }

    regenBtn.onclick = () => startPairing();
    pairStartBtn.onclick = () => startPairing();

    openSetup.onclick = () => showSetup();
    refreshBtn.onclick = () => refreshQr();

    function showViewer(){ setupBox.style.display='none'; viewerBox.style.display='block'; }
    function showSetup(){ setupBox.style.display='block'; viewerBox.style.display='none'; }

    (function init(){
      // Попытка сразу показать рабочий QR (если устройство уже привязано)
      showViewer(); refreshQr(); startTicker();
    })();
  </script>
</body>
</html>


